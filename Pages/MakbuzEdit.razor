@page "/makbuz-edit"
@page "/makbuz-edit/{Id:int}"
@using SiteYonetimApp.Models
@using SiteYonetimApp.Services
@inject IGeneralService GeneralService
@inject NavigationManager Navigation

<h3>@(IsEditMode ? "Makbuz Güncelle" : "Yeni Makbuz Ekle")</h3>

<EditForm Model="Makbuz" OnValidSubmit="SaveMakbuz">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="makbuzNo">Makbuz No</label>
        <input type="number" id="makbuzNo" class="form-control" @bind="Makbuz.MakbuzNo" />
        <ValidationMessage For="@(() => Makbuz.MakbuzNo)" />
    </div>
    <div class="form-group">
        <label for="ad">Adı</label>
        <input type="text" id="ad" class="form-control" @bind="Makbuz.Ad" />
        <ValidationMessage For="@(() => Makbuz.Ad)" />
    </div>
    <div class="form-group">
        <label for="soyad">Soyadı</label>
        <input type="text" id="soyad" class="form-control" @bind="Makbuz.Soyad" />
        <ValidationMessage For="@(() => Makbuz.Soyad)" />
    </div>
    <div class="form-group">
        <label for="daireNo">Daire No</label>
        <input type="text" id="daireNo" class="form-control" @bind="Makbuz.DaireNo" />
        <ValidationMessage For="@(() => Makbuz.DaireNo)" />
    </div>
    <div class="form-group">
        <label for="blok">Blok Adı</label>
        <select id="blok" class="form-control" @bind="Makbuz.BlokId">
            <option value="">Blok Seçin</option>
            @foreach (var blok in BlokListesi)
            {
                <option value="@blok.Id">@blok.BlokName</option>
            }
        </select>
        <ValidationMessage For="@(() => Makbuz.BlokId)" />
    </div>
    <div class="form-group">
        <label for="aidatDonemi">Aidat Dönemi</label>
        <input type="date" id="aidatDonemi" class="form-control" @bind="Makbuz.AidatDonemi" />
        <ValidationMessage For="@(() => Makbuz.AidatDonemi)" />
    </div>
    <div class="form-group">
        <label for="aidatTutari">Aidat Tutarı</label>
        <input type="number" id="aidatTutari" class="form-control" @bind="Makbuz.AidatTutari" />
        <ValidationMessage For="@(() => Makbuz.AidatTutari)" />
    </div>
    <div class="form-group">
        <label for="demirbasDonemi">Demirbaş Dönemi</label>
        <input type="date" id="demirbasDonemi" class="form-control" @bind="Makbuz.Demirbasonemi" />
        <ValidationMessage For="@(() => Makbuz.Demirbasonemi)" />
    </div>
    <div class="form-group">
        <label for="demirbasTutari">Demirbaş Tutarı</label>
        <input type="number" id="demirbasTutari" class="form-control" @bind="Makbuz.DemirbasTutari" />
        <ValidationMessage For="@(() => Makbuz.DemirbasTutari)" />
    </div>
    <div class="form-group">
        <label for="demirbasTutari">Aidat Faiz Tutarı</label>
        <input type="number" id="demirbasTutari" class="form-control" @bind="Makbuz.AidatFaizTutari" />
        <ValidationMessage For="@(() => Makbuz.AidatFaizTutari)" />
    </div>
    <div class="form-group">
        <label for="demirbasTutari">Toplam Tutar</label>
        <input type="number" id="demirbasTutari" class="form-control" @bind="Makbuz.ToplamTutar" />
        <ValidationMessage For="@(() => Makbuz.ToplamTutar)" />
    </div>
    <div class="form-group">
        <label for="ad">Ödeme Alan Ad</label>
        <input type="text" id="ad" class="form-control" @bind="Makbuz.OdemeyiAlanAd" />        
    </div>
    <div class="form-group">
        <label for="soyad">Ödeme Alan Soyad</label>
        <input type="text" id="soyad" class="form-control" @bind="Makbuz.OdemeyiAlanSoyad" />        
    </div>
    <div class="form-group">
        <label for="odemeYontemi">Ödeme Yöntemi</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div>
                <input type="checkbox" id="odemeBanka" @bind="Makbuz.Banka" />
                <label for="odemeBanka">Banka</label>
            </div>
            <div>
                <input type="checkbox" id="odemeNakit" @bind="Makbuz.Nakit" />
                <label for="odemeNakit">Nakit</label>
            </div>
        </div>      
    </div>
    <button class="btn btn-primary" type="submit">@(IsEditMode ? "Güncelle" : "Ekle")</button>
    <button class="btn btn-secondary" @onclick="Cancel">İptal</button>
</EditForm>

@code {
    [Parameter] public int? Id { get; set; }

    private Makbuz Makbuz = new Makbuz();
    private List<Makbuz> MakbuzListesi = new List<Makbuz>();
    private List<Blok> BlokListesi = new List<Blok>();
    private bool IsEditMode => Id.HasValue;

    protected override async Task OnInitializedAsync()
    {
        BlokListesi = await GeneralService.GetBloksAsync() ?? new List<Blok>();

        if (IsEditMode)
        {
            // Eğer güncelleme işlemi ise, ilgili makbuzu al
            MakbuzListesi = await GeneralService.GetMakbuzlarAsync() ?? new List<Makbuz>();
            Makbuz = MakbuzListesi.FirstOrDefault(m => m.Id == Id) ?? new Makbuz();
            Makbuz.Blok = BlokListesi.FirstOrDefault(b => b.Id == Makbuz.BlokId);
        }
    }

    private async Task SaveMakbuz()
    {
        Makbuz.Blok = BlokListesi.FirstOrDefault(b => b.Id == Makbuz.BlokId);
        Makbuz.OdemeyiAlanAd = Makbuz.OdemeyiAlanAd==null?"Nurol":Makbuz.OdemeyiAlanAd;
        Makbuz.OdemeyiAlanSoyad = Makbuz.OdemeyiAlanSoyad==null? "Balcı":Makbuz.OdemeyiAlanSoyad;
        Makbuz.TahsilEtmeText = "Tahsil Edilmiştir";
        Makbuz.OdemeyiAlanImza = "nurol.balci";
        if (IsEditMode)
        {
            MakbuzListesi = await GeneralService.GetMakbuzlarAsync() ?? new List<Makbuz>();
            var index = MakbuzListesi.FindIndex(m => m.Id == Makbuz.Id);
            if (index != -1)
            {
                MakbuzListesi[index] = Makbuz;
                await GeneralService.SaveMakbuzlarListAsync(MakbuzListesi);
            }
        }
        else
        {
            Makbuz.Id = MakbuzListesi.Any() ? MakbuzListesi.Max(m => m.Id) + 1 : 1;
            MakbuzListesi.Add(Makbuz);
            await GeneralService.AddMakbuzAsync(Makbuz);
        }
        Navigation.NavigateTo("/makbuzlar");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/makbuzlar");
    }

    private void OnBlokChanged(ChangeEventArgs e)
    {
        var selectedBlokId = int.Parse(e.Value.ToString());
        Makbuz.Blok = BlokListesi.FirstOrDefault(b => b.Id == selectedBlokId);
        Makbuz.BlokId = BlokListesi.FirstOrDefault(b => b.Id == selectedBlokId).Id;
    }
}